Claypool.AOP={};(function(c,b,a){c.manage("Claypool.AOP.Container","claypool:AOP")})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Aspect=function(d){this.id=null;this.type=null;b.extend(this,b.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Aspect");this.strategy=this.strategy||"all"};c.extend(a.Aspect.prototype,b.SimpleCachingStrategy.prototype,{weave:function(){var i=this;var g;var d;if(!this.target){i.logger.warn("No pointcut was specified.  Cant weave aspect.");return}var h=function(f){var k,j;try{i.logger.info("Weaving Advice %s for Aspect %s",f,i.id);i.hasPrototype=typeof(i.target.prototype)!="undefined";j=i.hasPrototype?i.target.prototype[f]:i.target[f];k=i.advise(j);if(!i.hasPrototype){i.target[f]=k}else{i.target.prototype[f]=k}return{pointcut:k,cutline:j}}catch(l){throw new a.WeaveError(l,"Weave")}};if(this.size===0){g=new RegExp(this[this.type?this.type:"method"]);d=this.target.prototype?this.target.prototype:this.target;for(var e in d){if(c.isFunction(d[e])&&g.test(e)){this.logger.debug("Adding aspect to method %s",e);this.add(c.uuid(),h(e));if(this.strategy==="first"){break}}}}return this},unweave:function(){var d;try{for(var g in this.cache){d=this.find(g);if(!this.hasPrototype){this.target[this.method]=d.cutline}else{this.target.prototype[this.method]=d.cutline}this.hasPrototype=null}this.clear()}catch(f){throw new a.WeaveError(f,"Unweave")}return true},advise:function(d){throw new b.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.After=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.After");this.type="after"};c.extend(a.After.prototype,a.Aspect.prototype,{advise:function(d){var g=this;try{return function(){var e=d.apply(this,arguments);return g.advice.apply(g,[e])}}catch(f){throw new a.AspectError(f,"After")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Before=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Before");this.type="before"};c.extend(a.Before.prototype,a.Aspect.prototype,{advise:function(d){var g=this;try{return function(){g.advice.apply(g,arguments);return d.apply(this,arguments)}}catch(f){throw new a.AspectError(f,"Before")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Around=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Around");this.type="around"};c.extend(a.Around.prototype,a.Aspect.prototype,{advise:function(d){var g=this;try{return function(){var e={object:this,args:arguments};return g.advice.apply(g,[{object:e.object,arguments:e.args,proceed:function(){var h=d.apply(e.object,e.args);return h}}])}}catch(f){throw new a.AspectError(f,"Around")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Factory=function(d){b.extend(this,b.BaseFactory);c.extend(true,this,d);this.configurationId="aop";this.aspectCache=null;this.logger=c.logger("Claypool.AOP.Factory");this.aspectCache=new b.SimpleCachingStrategy()};c.extend(a.Factory.prototype,b.BaseFactory.prototype,{updateConfig:function(){var l=this;var f;var k;var j;var h,g,d,n;try{this.logger.debug("Configuring Claypool AOP AspectFactory");f=this.getConfig()||[];this.logger.debug("AOP Configurations: %d",f.length);for(j=0;j<f.length;j++){try{k=f[j];if(!c.isFunction(k.advice)){k.advice=c.resolve(k.advice)}if(k.target.match("^ref://")){h=k.target.substr(6,k.target.length);c(document).bind("claypool:ioc:"+h,function(p,q,o){l.logger.debug("Creating aspect id %s for instance %s",k.id);var e=o.find(q);k.target=e._this;l.add(k.id,k);var i=l.create(k.id);e._this=i.target;o.remove(q);o.add(q,e);l.logger.debug("Created aspect \n%s, \n%s")}).bind("claypool:predestroy:"+h,function(o,e){l.logger.debug("Destroying aspect id %s for instance %s",k.id);var i=l.aspectCache.find(k.id);if(i&&i.unweave){i.unweave()}})}else{if(k.target.match(/\.\*$/)){this.logger.debug("Broad aspect target %s",k.target);g=c.resolve(k.target.substring(0,k.target.length-2));for(d in g){if(c.isFunction(g[d])){n=c.extend({},k,{id:k.id+c.uuid(),target:g[d]});this.logger.debug("Creating aspect id %s [%s] (%s)",k.target,d,n.id);this.add(n.id,n);this.create(n.id)}}}else{this.logger.debug("Creating aspect id %s",k.id);k.target=c.resolve(k.target);this.add(k.id,k);this.create(k.id)}}}catch(m){this.logger.exception(m)}}}catch(m){this.logger.exception(m);throw new a.ConfigurationError(m)}return true},create:function(k){var j;var d;var f=this.aspectCache.find(k);var i=this;var g=function(l){var e=null;if(l.after){e=new a.After(l)}else{if(l.before){e=new a.Before(l)}else{if(l.around){e=new a.Around(l)}}}return e.weave()};if(f){return f}else{try{this.logger.debug("Looking for configuration for aspect %s",k);j=this.find(k);if(j===undefined||j===null){this.logger.debug("%s is not an Aspect.",k);return null}else{this.logger.debug("Found configuration for instance %s",k);if(j.selector){this.logger.debug("Attaching contructor to an active selector");i=this;d=function(){f=g(j);i.aspectCache.add(j.id+"#"+this.toString(),f);return f};if(j.active){c(j.selector).livequery(d)}else{c(j.selector).each(d)}}else{f=g(j);this.aspectCache.add(k,f)}return f}}catch(h){this.logger.exception(h);throw new a.FactoryError(h)}}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Container=function(d){b.extend(this,b.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.AOP.Container");this.logger.debug("Configuring Claypool AOP Container");this.factory=new a.Factory(d);this.factory.updateConfig()};c.extend(a.Container.prototype,b.Application.ContextContributor.prototype,{get:function(g){var d;try{this.logger.debug("Search for a container managed aspect :%s",g);d=this.find(g);if(d===undefined||d===null){this.logger.debug("Can't find a container managed aspect :%s",g);d=this.factory.create(g);if(d!==null){this.add(g,d);return d}}else{this.logger.debug("Found container managed instance :%s",g);return d}}catch(f){this.logger.exception(f);throw new a.ContainerError(f)}return null}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.ContainerError=function(g,d){var f={name:"Claypool.AOP.ContainerError",message:"An error occured inside the aop container."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.ConfigurationError=function(g,d){var f={name:"Claypool.AOP.ConfigurationError",message:"An error occured updating the aop container configuration."};c.extend(this,new b.ConfigurationError(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.FactoryError=function(g,d){var f={name:"Claypool.AOP.FactoryError",message:"An error occured creating the aspect from the configuration."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.WeaveError=function(g,d){var f={name:"Claypool.AOP.WeaveError",message:"An error occured weaving or unweaving the aspect."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.AspectError=function(g,d){var f={name:"Claypool.AOP.AspectError",message:"An error occured while applying an aspect."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,a,b){c.extend(c,{filters:function(){if(arguments.length===0){return c.config("aop")}else{return c.config("aop",arguments[0])}}})})(jQuery,Claypool,Claypool.AOP);